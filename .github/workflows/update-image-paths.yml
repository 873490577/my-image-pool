name: Update Image Paths

on:
  push:
    branches: [ main, master ]
    paths:
      - '**.jpg'
      - '**.jpeg'
      - '**.png'
      - '**.gif'
      - '**.bmp'
      - '**.svg'
      - '**.webp'
      - 'scripts/**'  # æ·»åŠ è„šæœ¬å˜åŒ–ä¹Ÿè§¦å‘
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'

jobs:
  update-image-paths:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        # ç§»é™¤ cache é…ç½®ï¼Œå› ä¸ºæˆ‘ä»¬æ²¡æœ‰ requirements.txt
    
    - name: Generate image paths JSON
      id: generate
      run: |
        echo "å¼€å§‹ç”Ÿæˆå›¾ç‰‡è·¯å¾„JSON..."
        python scripts/generate_image_paths.py
        
        # è®¾ç½®è¾“å‡ºå˜é‡
        echo "total_images=$(python -c "import json; data=json.load(open('image_paths.json')); print(data['metadata']['total_images'])" )" >> $GITHUB_OUTPUT
      env:
        GITHUB_REPOSITORY: ${{ github.repository }}
        GITHUB_SHA: ${{ github.sha }}
        GITHUB_RUN_ID: ${{ github.run_id }}
    
    - name: Show generated data
      run: |
        echo "=== ç”Ÿæˆçš„JSONæ–‡ä»¶é¢„è§ˆ ==="
        if [ -f "image_paths.json" ]; then
          head -30 image_paths.json
          echo ""
          echo "=== ç»Ÿè®¡ä¿¡æ¯ ==="
          python -c "
import json
try:
    with open('image_paths.json', 'r', encoding='utf-8') as f:
        data = json.load(f)
    print(f'æ€»å›¾ç‰‡æ•°: {data[\"metadata\"][\"total_images\"]}')
    print(f'ç”Ÿæˆæ—¶é—´: {data[\"metadata\"][\"generated_at\"]}')
except Exception as e:
    print(f'è¯»å–JSONå¤±è´¥: {e}')
          "
        else
          echo "âŒ image_paths.json æ–‡ä»¶ä¸å­˜åœ¨"
        fi
    
    - name: Commit and push if changed
      if: github.event_name != 'pull_request'
      run: |
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
        echo "=== æ£€æŸ¥æ–‡ä»¶çŠ¶æ€ ==="
        git status
        
        echo "=== æ£€æŸ¥æ˜¯å¦æœ‰å›¾ç‰‡è·¯å¾„æ–‡ä»¶ ==="
        if [ -f "image_paths.json" ]; then
          echo "âœ… image_paths.json å­˜åœ¨ï¼Œå‡†å¤‡æäº¤"
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰å˜åŒ–
          git add image_paths.json
          
          if git diff-index --quiet HEAD --; then
            echo "âš ï¸  æ²¡æœ‰å˜åŒ–ï¼Œè·³è¿‡æäº¤"
          else
            echo "ğŸ“ æ£€æµ‹åˆ°å˜åŒ–ï¼Œæäº¤æ›´æ”¹"
            git commit -m "ğŸ“¸ Auto-update image paths JSON [skip ci]"
            
            echo "ğŸš€ æ¨é€æ›´æ”¹"
            git pull --rebase origin ${{ github.ref_name }}
            git push origin ${{ github.ref_name }}
            echo "âœ… å·²æˆåŠŸæ›´æ–° image_paths.json"
          fi
        else
          echo "âŒ image_paths.json ä¸å­˜åœ¨ï¼Œè·³è¿‡æäº¤"
        fi
