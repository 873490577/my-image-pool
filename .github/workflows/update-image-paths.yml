name: Update Image Paths

on:
  push:
    branches: [ main, master ]
    paths:
      - '**.jpg'
      - '**.jpeg'
      - '**.png'
      - '**.gif'
      - '**.bmp'
      - '**.svg'
      - '**.webp'
      # æ·»åŠ å…¶ä»–å›¾ç‰‡æ ¼å¼
  pull_request:
    branches: [ main, master ]
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  # å®šæ—¶è§¦å‘ï¼ˆæ¯å¤©å‡Œæ™¨2ç‚¹ï¼‰
  schedule:
    - cron: '0 2 * * *'

jobs:
  update-image-paths:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # éœ€è¦å†™æƒé™æ¥æäº¤æ›´æ”¹
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–æ‰€æœ‰å†å²è®°å½•
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
    
    - name: Generate image paths JSON
      id: generate
      run: |
        echo "å¼€å§‹ç”Ÿæˆå›¾ç‰‡è·¯å¾„JSON..."
        python scripts/generate_image_paths.py
      env:
        GITHUB_REPOSITORY: ${{ github.repository }}
        GITHUB_SHA: ${{ github.sha }}
        GITHUB_RUN_ID: ${{ github.run_id }}
    
    - name: Show generated data
      run: |
        echo "ç”Ÿæˆçš„JSONæ–‡ä»¶é¢„è§ˆ:"
        head -50 image_paths.json
        echo ""
        echo "æ€»å›¾ç‰‡æ•°: ${{ steps.generate.outputs.total_images }}"
    
    - name: Commit and push if changed
      if: github.event_name != 'pull_request'  # ä¸åœ¨PRä¸­æäº¤
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
        git add image_paths.json
        
        # å°è¯•æäº¤
        git diff --quiet && git diff --staged --quiet || \
          (git commit -m "ğŸ“¸ Auto-update image paths JSON [skip ci]" && \
           git pull --rebase && \
           git push)
        
        echo "âœ… å·²æ›´æ–° image_paths.json"
    
    - name: Create PR if on schedule
      if: github.event_name == 'schedule'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "ğŸ“¸ Auto-update image paths from scheduled run"
        title: "ğŸ“¸ Auto-update image paths JSON"
        body: |
          ## è‡ªåŠ¨æ›´æ–°å›¾ç‰‡è·¯å¾„
          
          æœ¬æ¬¡æ›´æ–°ç”±å®šæ—¶ä»»åŠ¡è§¦å‘ï¼Œæ›´æ–°äº†å›¾ç‰‡è·¯å¾„çš„JSONç´¢å¼•ã€‚
          
          **ç»Ÿè®¡ä¿¡æ¯:**
          - æ€»å›¾ç‰‡æ•°: ${{ steps.generate.outputs.total_images }}
          
          **è‡ªåŠ¨ç”Ÿæˆçš„æ–‡ä»¶:**
          - `image_paths.json`
          
          ---
          
          *æ­¤PRç”±GitHub Actionsè‡ªåŠ¨åˆ›å»º*
        branch: update/image-paths
        delete-branch: true
        labels: automated, images
